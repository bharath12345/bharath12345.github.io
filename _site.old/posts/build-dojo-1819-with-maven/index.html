<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta http-equiv="Cache-Control" content="no-cache"/>
    <meta http-equiv="Cache-Control" content="no-store"/>
    <meta http-equiv="Content-Encoding" content="gzip"/>
    <meta http-equiv="Expires" content="0"/>
    <meta http-equiv="Pragma" content="no-cache"/>

    <title>Bharath's Blog</title>

    <meta name="author" content="Bharadwaj"/>
    <meta name="description" content="thoughts, musings, writings"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="alternate" type="application/rss+xml" href="/atom.xml"/>

    <!-- CSS -->
    <link rel='stylesheet' type='text/css' href='http://fonts.googleapis.com/css?family=Open+Sans:400,300'>
    <link rel='stylesheet' type='text/css' href="/lib/up/up.css">
    <link rel='stylesheet' type='text/css' href="/lib/bootstrap/css/bootstrap.min.css">
    <link rel='stylesheet' type='text/css' href="/lib/bootstrap/css/bootstrap-responsive.min.css">
    <link rel='stylesheet' type='text/css' href="/lib/fontawesome/css/font-awesome.min.css">

    <!--[if lt IE 9]>
    <script type="text/javascript" src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="shortcut icon" href="/images/favicon.ico">

    <script>
        (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                    m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
        ga('create', 'UA-42349821-1', 'bharath12345.github.io');
        ga('send', 'pageview');
    </script>
</head>

<body>
<div id="fb-root"></div>
<script>
    window.fbAsyncInit = function() {
        // init the FB JS SDK
        FB.init({
            appId      : '557536207641096',                        // App ID from the app dashboard
            channelUrl : '//bharathwrites.in/channel.html', // Channel file for x-domain comms
            status     : true,                                 // Check Facebook Login status
            xfbml      : true                                  // Look for social plugins on the page
        });

        // Additional initialization code such as adding Event Listeners goes here
    };

    // Load the SDK asynchronously
    (function(d, s, id){
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) {return;}
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/en_US/all.js";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
</script>

<div class="navbar navbar-inverse navbar-fixed-top navbar-inner">
    <div class="container">
        <a class="navbar-brand" href="/">Bharadwaj</a>

        <div class="nav-collapse">
            <ul class="nav">
                <li>
                    <a class="navbar-link" href="/tags.html">Tags</a>
                </li>
                <li>
                    <a class="navbar-link" href="/categories.html">Categories</a>
                </li>
                <li>
                    <a class="navbar-link" href="/index.html">Index</a>
                </li>
                <li>
                    <a class="navbar-link" href="/search.html">Search</a>
                </li>
            </ul>
        </div>

        <div class="nav-collapse collapse">
            <ul class="nav navbar-nav pull-right hidden-print">
                <li>
                    <a class="hidden-sm" title="About me" href="/pages/about.html">
                        <i class="icon-user icon-fixed-width"></i>
                    </a>
                    <a class="visible-sm" title="About me" href="/pages/about.html">
                        <i class="icon-user icon-fixed-width"></i>
                        About me
                    </a>
                </li>
                <li>
                    <a class="hidden-sm" title="Follow me" href="https://twitter.com/bharathtalks">
                        <i class="icon-twitter icon-fixed-width"></i>
                    </a>
                    <a class="visible-sm" title="Atom Feed" href="https://twitter.com/bharathtalks">
                        <i class="icon-twitter icon-fixed-width"></i>
                        Follow me
                    </a>
                </li>
                <li>
                    <a class="hidden-sm" title="Projects" href="https://github.com/bharath12345">
                        <i class="icon-github icon-fixed-width"></i>
                    </a>
                    <a class="visible-sm" title="Projects" href="https://github.com/bharath12345">
                        <i class="icon-github icon-fixed-width"></i>
                        GitHub Projects
                    </a>
                </li>
                <li>
                    <a class="hidden-sm" title="CV" href="http://www.linkedin.com/in/bharadwajn">
                        <i class="icon-linkedin icon-fixed-width"></i>
                    </a>
                    <a class="visible-sm" title="CV" href="http://www.linkedin.com/in/bharadwajn">
                        <i class="icon-linkedin icon-fixed-width"></i>
                        CV
                    </a>
                </li>
                <li>
                    <a class="hidden-sm" title="Facebook" href="https://www.facebook.com/bharadwajn">
                        <i class="icon-facebook icon-fixed-width"></i>
                    </a>
                    <a class="visible-sm" title="Facebook" href="https://www.facebook.com/bharadwajn">
                        <i class="icon-facebook icon-fixed-width"></i>
                        Facebook
                    </a>
                </li>
                <li>
                    <a class="hidden-sm" title="Videos" href="http://www.youtube.com/user/bharadwajnarasimha">
                        <i class="icon-youtube icon-fixed-width"></i>
                    </a>
                    <a class="visible-sm" title="Videos" href="http://www.youtube.com/user/bharadwajnarasimha">
                        <i class="icon-youtube icon-fixed-width"></i>
                        YouTube Videos
                    </a>
                </li>
            </ul>
        </div>
    </div>
</div>

<div class="container">
    <section class="content">
    <h1>
        <a href="/posts/build-dojo-1819-with-maven">Build Dojo 1.7/1.8/1.9 with Maven</a>
    </h1>

    <section class="byline">
        July 18, 2013
    </section>
    <hr>
    <table>
        <tr>
            <td><a  href="https://twitter.com/share" class="twitter-share-button"
data-via="bharathtalks" data-lang="en" data-size="medium">Tweet</a>
<script>
!function(d,s,id){
  var js,fjs=d.getElementsByTagName(s)[0];
  if(!d.getElementById(id)){
    js=d.createElement(s);
    js.id=id;
    js.src="//platform.twitter.com/widgets.js";
    fjs.parentNode.insertBefore(js,fjs);
  }
}(document,"script","twitter-wjs");
</script>
</td>
            <td>
                <div class="fb-like" data-send="false" data-layout="standard" data-width="450" data-show-faces="false" data-colorscheme="light" data-action="like"></div>
            </td>
        </tr>
    </table>
    <hr>
    <p>I have been a Dojo user for many years now. Also use many JavaScript libraries (jQuery, backbone, bootstrap, D3, highsoft) all the while but Dojo is what I really love. I would not embark on any &ldquo;professional&rdquo; development work without being armed with Dojo. But I rest my opinions and comparisons of different JS libraries for a different blog. Here the context is to &ldquo;build&rdquo; Dojo. After all every professional project should do a build of their JS - compilers like Google Closure can find bugs, obfuscate and eventually make execution faster.</p>

<p>I still am mainly a Java programmer (the enterprise products I have built are predominantly in Java… time split between Java/JavaScript may be 70/30). So am used to Maven as my primary build tool. And Maven I shall use to build Dojo.</p>

<p>Folks who have not tried to build Dojo should probably start-off by reading these two articles -</p>

<ul>
<li><a href="http://dojotoolkit.org/documentation/tutorials/1.9/build/">Creating Builds</a> from Dojo documentation</li>
<li><a href="http://www.mahieu.org/?p=3">Creating custom Dojo builds in Maven</a></li>
</ul>


<p>The last article is very good but slightly dated. And here is what I propose to add to it -</p>

<ol>
<li>Use dojo v1.9 (v1.8 and v1.7 with AMD should also work perfectly)</li>
<li>I use WebStorm as my JavaScript IDE. It has excellent contextual support including that for Dojo. However, it requires Dojo to be at a constant referencable path from where it could index. Once the indexes are built, typing a &ldquo;.&rdquo; after an object should show up the list of methods and variables belonging to that object. This is extremely useful for fast development</li>
<li>Dojo builds are slow. A typical build from source download to unzip to compile to build WAR can take anywhere between 5 to 15 minutes. This can be painful and needs to be made faster</li>
</ol>


<p>Now, here is the how…</p>

<h4>Task 1: Installing Dojo in Maven Repository and Unpack Task</h4>

<p>This is no different from the Step 1 &amp; 2 in Mahieu blog. The unzipped sources are placed in src/main/js of my maven hierarchy. I dont do any renaming of this directory.</p>

<h4>Task 2: Move Dojo sources</h4>

<p>The unpack task unzips the dojo sources in &ldquo;src/main/js/dojo-release-${dojo.version}-src&rdquo; directory. This is okay but not good for repeated builds. I would like a structure like shown in the picture below - all my JS libraries under src/main/js.</p>

<p><img src="https://raw.github.com/bharath12345/bharath12345.github.io/master/images/dojo%20blog/dojo%20blog%20structure.png" alt="image" /></p>

<p>This structure helps in one major way - it helps my WebStorm IDE to index the JS. The Dojo JS are always in &ldquo;src/main/js&rdquo; alongwith other libraries and WebStorm understands this very well!</p>

<p>I use antrun for its ability to run <strong>parallel copy tasks</strong> - parallelism helps in making the build much faster. And I <strong>delete</strong> the original unzipped directory at the end.</p>

<pre><code>&lt;plugin&gt;
    &lt;artifactId&gt;maven-antrun-plugin&lt;/artifactId&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;id&gt;Copy Dojo&lt;/id&gt;
            &lt;configuration&gt;
                &lt;tasks&gt;
                    &lt;parallel&gt;
                        &lt;copy todir="${js-dir}/" failonerror="false"&gt;
                            &lt;fileset dir="${dojoSrc}"&gt;
                                &lt;include name="dijit/"/&gt;
                           &lt;/fileset&gt;
                       &lt;/copy&gt;
                       &lt;copy todir="${js-dir}/" failonerror="false"&gt;
                            &lt;fileset dir="${dojoSrc}"&gt;
                                &lt;include name="dojox/"/&gt;
                           &lt;/fileset&gt;
                       &lt;/copy&gt;
                       &lt;copy todir="${js-dir}/" failonerror="false"&gt;
                            &lt;fileset dir="${dojoSrc}"&gt;
                                &lt;include name="dojo/"/&gt;
                           &lt;/fileset&gt;
                       &lt;/copy&gt;
                       &lt;copy todir="${js-dir}/" failonerror="false"&gt;
                            &lt;fileset dir="${dojoSrc}"&gt;
                                &lt;include name="util/"/&gt;
                           &lt;/fileset&gt;
                       &lt;/copy&gt;
                   &lt;/parallel&gt;
                   &lt;delete dir="${dojoSrc}" quiet="true"/&gt;
               &lt;/tasks&gt;
            &lt;/configuration&gt;
            &lt;phase&gt;process-sources&lt;/phase&gt;
            &lt;goals&gt;
                &lt;goal&gt;run&lt;/goal&gt;
            &lt;/goals&gt;
       &lt;/execution&gt;
    &lt;/executions&gt;
&lt;/plugin&gt;
</code></pre>

<h4>Task 3: Build Dojo</h4>

<p>For this again, I use the antrun plugin. This build leads to creation of dojo/dijit/dojox directories under src/main/js.</p>

<pre><code>&lt;plugin&gt;
    &lt;artifactId&gt;maven-antrun-plugin&lt;/artifactId&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;id&gt;AppsOne dojo ${dojo.version} Custom Build&lt;/id&gt;
            &lt;phase&gt;compile&lt;/phase&gt;
            &lt;configuration&gt;
                &lt;tasks&gt;
                    &lt;parallel&gt;
                        &lt;java classname="org.mozilla.javascript.tools.shell.Main"
                    fork="true" maxmemory="512m" failonerror="false"
                    classpath="${shrinksafe-dir}/js.jar${path.separator}${closure-dir}/compiler.jar${path.separator}${shrinksafe-dir}/shrinksafe.jar"&gt;
                            &lt;arg value="${js-dir}/dojo/dojo.js"/&gt;
                            &lt;arg value="baseUrl=${js-dir}/dojo"/&gt;
                            &lt;arg value="load=build"/&gt;
                            &lt;arg line="--profile ${basedir}/dashboard.profile.js"/&gt;
                            &lt;arg value="--release"/&gt;
                        &lt;/java&gt;
                    &lt;/parallel&gt;
                &lt;/tasks&gt;
            &lt;/configuration&gt;
            &lt;goals&gt;
                &lt;goal&gt;run&lt;/goal&gt;
            &lt;/goals&gt;
        &lt;/execution&gt;
    &lt;/executions&gt;
&lt;/plugin&gt;
</code></pre>

<h4>Task 4: The Dojo Profile</h4>

<p><a href="https://github.com/bharath12345/uiDashboard/blob/master/uiJS/dashboard.profile.js">This is the link</a> to the profile script I use. It has a lot of comments for the reader to understand. One can find a lot of options to tune the Dojo build by specifying options in the profile. The profile specifies thus -</p>

<ul>
<li>I name my JS project as &ldquo;Dashboard&rdquo; - so I want the built artifacts to be in the target/dashboard directory</li>
<li>Use the closure compiler</li>
<li>I use both dgrid and gridx in my project along with its dependencies (xstyle, dbind, put-selector) - so those have to be included</li>
<li>Including my project&rsquo;s JS - which are present in the &ldquo;dashboard&rdquo; directory and are AMD complying JS</li>
<li>Finally I want to see less verbose prints on my console - so I set the logging level to SEVERE</li>
</ul>


<h4>Task 5: Clean the Uncompressed JavaScript</h4>

<p>Dojo build generates minimized JS. And in the process of doing so it retains the originial JS but renames them to have &ldquo;uncompressed&rdquo; in their filenames. This is useful for debugging purposes. But surely, we dont want these uncompressed JS to be part of the built WAR. It increases the size of the WAR (at least doubles it - taking it well above 50MB!). So, a task to remove these uncompressed JS from target directory is required. This maven stub does just that -</p>

<pre><code> &lt;plugin&gt;
    &lt;artifactId&gt;maven-clean-plugin&lt;/artifactId&gt;
    &lt;version&gt;2.5&lt;/version&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;id&gt;clean-js&lt;/id&gt;
            &lt;phase&gt;prepare-package&lt;/phase&gt;
            &lt;goals&gt;
                &lt;goal&gt;clean&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;configuration&gt;
            &lt;filesets&gt;
                &lt;fileset&gt;
                    &lt;directory&gt;${release-dir}/dojo&lt;/directory&gt;
                    &lt;includes&gt;
                        &lt;include&gt;**/*uncompressed.js&lt;/include&gt;
                    &lt;/includes&gt;
                    &lt;followSymlinks&gt;true&lt;/followSymlinks&gt;
               &lt;/fileset&gt;
            &lt;/configuration&gt;
         &lt;/execution&gt;
      &lt;/executions&gt;
&lt;/plugin&gt;
</code></pre>

<h4>Task 6: Copy Other JavaScript libraries</h4>

<p>By now, the &ldquo;target/dashboard/js&rdquo; has all the dojo sources along with project specific built in it. The next task is to copy other JS library dependencies. In my project, I typically use D3, jQuery and jsPlumb. So here is I copy them into this directory into maven&rsquo;s target by stub&rsquo;s like these -</p>

<pre><code>&lt;plugin&gt;
    &lt;artifactId&gt;maven-resources-plugin&lt;/artifactId&gt;
    &lt;version&gt;2.6&lt;/version&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;id&gt;copy-d3&lt;/id&gt;
            &lt;phase&gt;process-resources&lt;/phase&gt;
            &lt;goals&gt;
                &lt;goal&gt;copy-resources&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;configuration&gt;
                &lt;outputDirectory&gt;${gui.target.gui.location}/js/d3&lt;/outputDirectory&gt;
               &lt;resources&gt;
                    &lt;resource&gt;
                        &lt;directory&gt;${js-dir}/d3&lt;/directory&gt;
                   &lt;/resource&gt;
               &lt;/resources&gt;
            &lt;/configuration&gt;
          &lt;/execution&gt;
      &lt;/executions&gt;
&lt;/plugin&gt;
</code></pre>

<h4>Task 7: A fast build profile</h4>

<p>Dojo ZIP is upwards of 35MB in size with thousands of files. Downloading, unarchiving and moving it around makes it a heavy duty operation which is painfully slow. This makes a maven profile for faster build absolutely necessary. This profile does the following -</p>

<ul>
<li>Assumes the presence of unarchived dojo bundle in the source tree under &ldquo;src/main/js&rdquo;</li>
<li>It thus does none of the unarchiving or file movements and starts off directly with a closure build</li>
<li>Does not delete the dojo/dijit/dojox directories from under src/main/js after the build is complete</li>
</ul>


<p>Readers can refer to this <a href="https://github.com/bharath12345/uiDashboard/blob/master/uiJS/pom.xml">pom.xml</a> from one of my projects on GitHub. It has all that I have described above. Ping me if you run into any issues using my code, understanding my blog or anything else. Thanks for reading!</p>

    <hr>
    <div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'bharathtalks';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</section>

</div>

<div id="footer" class="hidden-print">
    <section class="meta">
        <div class="container">
            <div class="row">
            </div>
        </div>
    </section>
</div>

<script type="text/javascript">

var _gaq = _gaq || [];
_gaq.push(['_setAccount', '{"provider"=>"google", "google"=>{"tracking_id"=>"UA-42349821-1"}}']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

</script>




</body>

<script type="text/javascript" src="/lib/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/lib/jQuery/jquery-1.10.2.min.js"></script>
<script data-dojo-config="async: 1, dojoBlankHtmlUrl: '/blank.html',
        packages: [ {
            name: 'custom',
            location: location.pathname.replace(/\/[^/]+$/, '') + '/js/custom'
        } ]"
        src="//ajax.googleapis.com/ajax/libs/dojo/1.9.1/dojo/dojo.js">

    require(["dojo/dom", "dojo/domReady!"], function(dom){

        console.log("loaded = " + dom);
    });
</script>
</html>
